<head>
    <link rel="stylesheet" href="../../node_modules/figma-plugin-ds/dist/figma-plugin-ds.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
</head>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    
    .slider-group {
        border: none;
    }
    
    .slider-input {
        flex-grow: 1;
        margin: 0 16px;
    }
    
    .slider,
    .colorpicker-group {
        background: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    
    label {
        margin: 0;
        color: #333333;
        font-size: 0.8em;
        font-weight: 400;
    }
    
    .colorpicker-input {
        display: block;
        margin-top: 4px;
    }
</style>

<body>
    <fieldset class="slider-group">
        <!-- Intensity Slider -->
        <div class="slider">
            <label for="intensity-slider" class="slider-label">Intensity:</label>
            <input id="intensity-slider" class="slider-input" type="range" min="0" max="100" value="0" />
        </div>
        <!-- Size/Spread Slider -->
        <div class="slider">
            <label for="spread-slider" class="slider-label">Size:</label>
            <input id="spread-slider" class="slider-input" type="range" min="0" max="100" value="0" />
        </div>
        <!-- Opacity Slider -->
        <div class="slider">
            <label for="opacity-slider" class="slider-label">Opacity:</label>
            <input id="opacity-slider" class="slider-input" type="range" min="0" max="100" value="100" />
        </div>
    </fieldset>

    <!-- Color Pickers -->
    <fieldset class="colorpicker-group">
        <!-- Intensity Color Picker -->
        <div class="colorpicker">
            <label for="intensity-colorpicker" class="label">
        Intensity
      </label>
            <input id="intensity-colorpicker" class="colorpicker-input" type="color" value="#ffffff" />
        </div>

        <div class="colorpicker">
            <label for="spread-colorpicker" class="label">Spread</label>
            <input id="spreadColorPicker" class="colorpicker-input" type="color" value="#ffffff" />
        </div>
    </fieldset>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const intensityInput = document.getElementById('intensity')
            const spreadInput = document.getElementById('spread')
            const opacityInput = document.getElementById('opacity')
            document
                .getElementById('upgradeButton')
                .addEventListener('click', function(event) {
                    // Prevent default action if the href hasn't been updated yet
                    event.preventDefault()

                    // Retrieve the user token and fetch user data
                    figma.clientStorage.getAsync('userToken').then((userToken) => {
                        if (userToken) {
                            fetch('https://samoramabuya.com/api/paypal/create-subscription', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        Authorization: `Bearer ${userToken}`,
                                    },
                                    body: JSON.stringify({
                                        planId: 'P-0TU03491DA613900VMXEIHTQ', // Your PayPal plan ID
                                    }),
                                })
                                .then((response) => response.json())
                                .then((data) => {
                                    // Update the href attribute with the PayPal URL
                                    const upgradeButton = document.getElementById('upgradeButton')
                                    upgradeButton.href = data.approvalUrl
                                        // Optionally, trigger the navigation immediately
                                    window.location.href = data.approvalUrl
                                })
                                .catch((error) => console.error('Error:', error))
                        } else {
                            console.error('User token is not available.')
                        }
                    })
                })

            const intensityColorPicker = document.getElementById(
                'intensityColorPicker',
            )
            const spreadColorPicker = document.getElementById('spreadColorPicker')

            let isDragging = false
            let initialValue = null

            document.addEventListener('mousedown', (e) => {
                if (e.target.type === 'range') {
                    isDragging = true
                    initialValue = e.target.value
                }
            })

            document.addEventListener('mouseup', (e) => {
                if (
                    isDragging &&
                    e.target.type === 'range' &&
                    initialValue !== e.target.value
                ) {
                    parent.postMessage({
                            pluginMessage: {
                                type: 'decrement-credit',
                                // You can send the new value or any other relevant information here
                            },
                        },
                        '*',
                    )
                }
                isDragging = false
                initialValue = null
            })

            intensityInput.addEventListener('input', () => {
                const intensityValue = intensityInput.value
                parent.postMessage({
                        pluginMessage: {
                            type: 'intensity-change',
                            value: intensityValue,
                        },
                    },
                    '*',
                )
            })

            spreadInput.addEventListener('input', () => {
                const spreadValue = spreadInput.value
                parent.postMessage({
                        pluginMessage: {
                            type: 'spread-change',
                            value: spreadValue,
                        },
                    },
                    '*',
                )
            })

            intensityColorPicker.addEventListener('input', () => {
                parent.postMessage({
                        pluginMessage: {
                            type: 'intensityColor-change',
                            color: intensityColorPicker.value,
                        },
                    },
                    '*',
                )
            })

            opacityInput.addEventListener('input', () => {
                const opacityValue = opacityInput.value
                parent.postMessage({
                        pluginMessage: {
                            type: 'opacity-change',
                            value: opacityValue,
                            updateOnly: true,
                        },
                    },
                    '*',
                )
            })

            spreadColorPicker.addEventListener('input', () => {
                parent.postMessage({
                        pluginMessage: {
                            type: 'spreadColor-change',
                            color: spreadColorPicker.value,
                        },
                    },
                    '*',
                )
            })
        })

        window.onload = () => {
            parent.postMessage({
                    pluginMessage: {
                        type: 'ui-ready',
                    },
                },
                '*',
            )
        }

        window.onmessage = (event) => {
            if (event.origin !== ' http://localhost:3000') {
                return
            }
            if (event.data && event.data.pluginMessage) {
                const {
                    type,
                    value,
                    color,
                    creditsLeft
                } = event.data.pluginMessage

                console.log('data', event.data)
                console.log('value', value)

                if (type === 'update-intensity-ui') {
                    document.getElementById('intensity').value = value
                }
                if (type === 'update-spread-ui') {
                    document.getElementById('spread').value = value
                }
                if (type === 'reset-range-ui') {
                    document.getElementById('intensity').value = 0
                    document.getElementById('spread').value = 0
                    document.getElementById('opacity').value = 100
                }
                if (type === 'update-intensityColor-ui') {
                    document.getElementById('intensity-colorpicker').value = color
                }
                if (type === 'update-spreadColor-ui') {
                    document.getElementById('spreadColorPicker').value = color
                }
                if (type === 'update-opacity-ui') {
                    document.getElementById('opacity').value = Number(value)
                }
                if (type === 'update-credits') {
                    const creditsRemaining = document.getElementById('creditsRemaining')
                    if (creditsRemaining) {
                        creditsRemaining.value = creditsLeft.toString()
                    }
                }
            } else {
                console.log(
                    'Received message without pluginMessage property',
                    event.data,
                )
            }
        }
    </script>
</body>